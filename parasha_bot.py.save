from telegram.ext import ApplicationBuilder, CommandHandler, 
CallbackQueryHandler, ContextTypes
sqimport os
import logging
import asyncio
import json
from telegram import InlineKeyboardButton, InlineKeyboardMarkup, Update
from telegram.ext import ApplicationBuilder, CommandHandler, 
CallbackQueryHandler, ContextTypes
from openai import OpenAI
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger
from dotenv import load_dotenv

# --- ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ ---
load_dotenv()
TELEGRAM_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
LANG_FILE = "user_langs.json"

# --- Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ---
logging.basicConfig(format="%(asctime)s - %(levelname)s - %(message)s", 
level=logging.INFO)
bot_app = None
openai_client = OpenAI(api_key=OPENAI_API_KEY)
user_langs = {}

# --- Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ñ ÑĞ·Ñ‹ĞºĞ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ğ¼Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ ---
def load_user_langs():
    global user_langs
    if os.path.exists(LANG_FILE):
        with open(LANG_FILE, 'r', encoding='utf-8') as f:
            user_langs = json.load(f)
    else:
        user_langs = {}

def save_user_langs():
    with open(LANG_FILE, 'w', encoding='utf-8') as f:
        json.dump(user_langs, f, ensure_ascii=False, indent=2)

# --- Ğ¥ÑĞ½Ğ´Ğ»ĞµÑ€Ñ‹ ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    buttons = [
        InlineKeyboardButton("Ğ ÑƒÑÑĞºĞ¸Ğ¹", callback_data="lang|ru"),
        InlineKeyboardButton("English", callback_data="lang|en"),
        InlineKeyboardButton("×¢×‘×¨×™×ª", callback_data="lang|he"),
    ]
    keyboard = InlineKeyboardMarkup([buttons])
    await update.message.reply_text(
        "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ·Ñ‹Ğº / Choose your language / ×‘×—×¨ ×©×¤×”:",
        reply_markup=keyboard
    )

async def lang_callback(update: Update, context: 
ContextTypes.DEFAULT_TYPE):
    await update.callback_query.answer()
    lang = update.callback_query.data.split("|")[1]
    user_id = str(update.effective_user.id)
    user_langs[user_id] = lang
    save_user_langs()
    labels = {'ru': 'Ğ ÑƒÑÑĞºĞ¸Ğ¹', 'en': 'English', 'he': '×¢×‘×¨×™×ª'}
    await update.callback_query.edit_message_text(f"Ğ¯Ğ·Ñ‹Ğº ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½: 
{labels.get(lang)}")

# --- Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ° ---
async def generate_parasha_summary(lang: str) -> str:
    if lang == 'en':
        system = "You are an expert on the Torah, explaining its weekly 
portion simply in English."
        prompt = "Write a simple summary of this week's Torah portion for 
those unfamiliar with religious texts."
    elif lang == 'he':
        system = "××ª×” ××•××—×” ×œ×ª×•×¨×” ×•××¡×‘×™×¨ ××ª ×”×¤×¨×©×” ×”×©×‘×•×¢×™×ª ×‘×¤×©×˜×•×ª ×‘×¢×‘×¨×™×ª."
        prompt = "×›×ª×•×‘ ×ª×§×¦×™×¨ ×¤×©×•×˜ ×©×œ ×”×¤×¨×©×” ×”×©×‘×•×¢×™×ª ×¢×‘×•×¨ ××™ ×©×œ× ××›×™×¨ ×˜×§×¡×˜×™× 
×“×ª×™×™×."
    else:
        system = "Ğ¢Ñ‹ ÑĞºÑĞ¿ĞµÑ€Ñ‚ Ğ¿Ğ¾ ĞµĞ²Ñ€ĞµĞ¹ÑĞºĞ¸Ğ¼ Ñ‚ĞµĞºÑÑ‚Ğ°Ğ¼ Ğ¸ ÑƒĞ¼ĞµĞµÑˆÑŒ Ğ¾Ğ±ÑŠÑÑĞ½ÑÑ‚ÑŒ Ğ¸Ñ… 
Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ğ¼ ÑĞ·Ñ‹ĞºĞ¾Ğ¼."
        prompt = "ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ğ¼ ÑĞ·Ñ‹ĞºĞ¾Ğ¼ ĞºÑ€Ğ°Ñ‚ĞºĞ¸Ğ¹ Ğ¿ĞµÑ€ĞµÑĞºĞ°Ğ· Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ 
Ğ³Ğ»Ğ°Ğ²Ñ‹ Ğ¢Ğ¾Ñ€Ñ‹."
    resp = openai_client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "system", "content": system}, {"role": "user", 
"content": prompt}],
        temperature=0.7
    )
    return resp.choices[0].message.content.strip()

async def generate_midweek_reflection(lang: str) -> str:
    if lang == 'en':
        system = "You are a wise mentor and list reflection points clearly 
in English."
        prompt = "List key lessons and reflection points from this week's 
Torah portion midweek."
    elif lang == 'he':
        system = "××ª×” ××•×¨×” ×—×›× ×•×¨×•×©× × ×§×•×“×•×ª ×—×©×™×‘×” ×‘×¨×•×¨×•×ª ×‘×¢×‘×¨×™×ª."
        prompt = "×¨×©×•× × ×§×•×“×•×ª ×œ×™××•×“ ××”×¤×¨×©×” ×”×©×‘×•×¢×™×ª ×‘×××¦×¢ ×”×©×‘×•×¢."
    else:
        system = "Ğ¢Ñ‹ Ğ¼ÑƒĞ´Ñ€Ñ‹Ğ¹ Ğ½Ğ°ÑÑ‚Ğ°Ğ²Ğ½Ğ¸Ğº, Ñ„Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ¸Ñ€ÑƒÑÑ‰Ğ¸Ğ¹ Ğ¼Ñ‹ÑĞ»Ğ¸ ÑÑĞ½Ğ¾."
        prompt = "ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿ÑƒĞ½ĞºÑ‚Ğ¾Ğ²: Ñ‡ĞµĞ¼Ñƒ Ğ½Ğ°Ñ ÑƒÑ‡Ğ¸Ñ‚ Ñ‚ĞµĞºÑƒÑ‰Ğ°Ñ 
Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ³Ğ»Ğ°Ğ²Ğ° Ğ¢Ğ¾Ñ€Ñ‹."
    resp = openai_client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "system", "content": system}, {"role": "user", 
"content": prompt}],
        temperature=0.7
    )
    return resp.choices[0].message.content.strip()

async def generate_shabbat_toast(lang: str) -> str:
    if lang == 'en':
        system = "You are familiar with Shabbat traditions and craft warm 
toasts in English."
        prompt = "Create a short, heartfelt Shabbat toast based on this 
week's Torah portion."
    elif lang == 'he':
        system = "××ª×” ××›×™×¨ ××ª ××¡×•×¨×ª ×”×©×‘×ª ×•×™×•×¦×¨ ×‘×¨×›×” ×—××” ×‘×¢×‘×¨×™×ª."
        prompt = "×›×ª×•×‘ ×‘×¨×›×ª ×©×‘×ª ×§×¦×¨×” ×¢×œ ×¤×™ ×”×¤×¨×©×” ×”×©×‘×•×¢×™×ª."
    else:
        system = "Ğ¢Ñ‹ Ğ·Ğ½Ğ°ĞµÑˆÑŒ Ñ‚Ñ€Ğ°Ğ´Ğ¸Ñ†Ğ¸Ğ¸ ÑˆĞ°Ğ±Ğ±Ğ°Ñ‚Ğ° Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°ĞµÑˆÑŒ Ñ‚ĞµĞ¿Ğ»Ñ‹Ğµ Ñ‚Ğ¾ÑÑ‚Ñ‹."
        prompt = "ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ÑŒ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ Ñ‚ĞµĞ¿Ğ»Ñ‹Ğ¹ Ñ‚Ğ¾ÑÑ‚ Ğ´Ğ»Ñ ÑˆĞ°Ğ±Ğ±Ğ°Ñ‚Ğ° Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ 
Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ğ³Ğ»Ğ°Ğ²Ñ‹ Ğ¢Ğ¾Ñ€Ñ‹."
    resp = openai_client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "system", "content": system}, {"role": "user", 
"content": prompt}],
        temperature=0.7
    )
    return resp.choices[0].message.content.strip()

# --- Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ° Ğ¿Ğ¾ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ ---
async def send_weekly_summary():
    for user_id, lang in user_langs.items():
        text = await generate_parasha_summary(lang)
        await bot_app.bot.send_message(chat_id=int(user_id), text=f"ğŸ“– 
ĞŸĞµÑ€ĞµÑĞºĞ°Ğ· Ğ³Ğ»Ğ°Ğ²Ñ‹:\n{text}")

async def send_midweek_reflection():
    for user_id, lang in user_langs.items():
        text = await generate_midweek_reflection(lang)
        await bot_app.bot.send_message(chat_id=int(user_id), text=f"ğŸ’¡ 
Ğ§ĞµĞ¼Ñƒ Ğ½Ğ°Ñ ÑƒÑ‡Ğ¸Ñ‚ Ğ³Ğ»Ğ°Ğ²Ğ°:\n{text}")

async def send_shabbat_toast():
    for user_id, lang in user_langs.items():
        text = await generate_shabbat_toast(lang)
        await bot_app.bot.send_message(chat_id=int(user_id), text=f"ğŸ¥‚ 
Ğ¢Ğ¾ÑÑ‚ Ğº ÑˆĞ°Ğ±Ğ±Ğ°Ñ‚Ñƒ:\n{text}")

# --- Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ° Ğ¸ Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ñ‰Ğ¸ĞºĞ° ---
async def main():
    global bot_app
    load_user_langs()
    app = ApplicationBuilder().token(TELEGRAM_TOKEN).build()
    bot_app = app

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("language", start))
    app.add_handler(CallbackQueryHandler(lang_callback, 
pattern=r"^lang\|"))

    scheduler = AsyncIOScheduler(timezone="Asia/Dubai")
    scheduler.add_job(lambda: asyncio.create_task(send_weekly_summary()), 
CronTrigger(day_of_week="mon", hour=10, minute=0))
    scheduler.add_job(lambda: 
asyncio.create_task(send_midweek_reflection()), 
CronTrigger(day_of_week="wed", hour=10, minute=0))
    scheduler.add_job(lambda: asyncio.create_task(send_shabbat_toast()), 
CronTrigger(day_of_week="fri", hour=11, minute=0))
    scheduler.start()

    await app.run_polling()

if __name__ == "__main__":
    asyncio.run(main())

